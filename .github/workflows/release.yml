name: Release

on:
  # æ¨é€ç‰ˆæœ¬ tagï¼ˆä¾‹å¦‚ v0.1.2ï¼‰æ—¶è‡ªåŠ¨è§¦å‘
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+*"
  # æ‰‹åŠ¨åœ¨ Actions é¡µé¢è§¦å‘
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (e.g., v0.1.2)"
        required: true
        type: string

permissions:
  contents: write # Required for creating GitHub releases

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          echo "Before cleanup:"
          df -h

          # åˆ æ‰ä¸€å † GitHub è‡ªå¸¦ä½†ä½ ç”¨ä¸åˆ°çš„ä¸œè¥¿
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf "$AGENT_TOOLSDIRECTORY" || true
          sudo rm -rf /opt/hostedtoolcache || true
          docker system prune -af || true

          echo "After cleanup:"
          df -h

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Determine release version
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      # ç”¨ docker/build-push-action ç›´æ¥ build Dockerfile å¹¶æ¨åˆ° Docker Hub
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile          # å¦‚æœä½ çš„ Dockerfile åå­—/è·¯å¾„ä¸åŒï¼Œè¿™é‡Œæ”¹ä¸€ä¸‹
          push: true
          tags: |
            xiaoluo888/worker-fastdeploy:${{ steps.vars.outputs.version }}
            xiaoluo888/worker-fastdeploy:latest

      - name: Release Summary
        run: |
          echo "ğŸš€ Release completed!"
          echo "Version: ${{ steps.vars.outputs.version }}"
          echo "Docker Image: xiaoluo888/worker-fastdeploy:${{ steps.vars.outputs.version }}"
          echo "Docker Image (latest): xiaoluo888/worker-fastdeploy:latest"
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Trigger: Manual workflow dispatch"
          else
            echo "Trigger: Tag push ($GITHUB_REF)"
          fi
